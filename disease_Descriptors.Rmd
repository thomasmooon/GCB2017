---
title: "disease_Descriptors.Rmd"
subtitle: ""
author: "Thomas Gerlach"
date: ""
output: html_document
---

# setup
```{r start, echo=FALSE, include = FALSE}
rm(list=setdiff(ls(), "TABLE04SAS7BDAT"))
knitr::opts_chunk$set(echo = FALSE, fig.width=10, fig.height=7) # markdown
source("z_start.R") # initalize netezza DB, load core data
if(!exists("TABLE04SAS7BDAT")) load("./data/TABLE04SAS7BDAT.RData")
```

# global params
```{r}
params <- vector("list")
params$thres.subst.freq   <- 2
```

# script specific functions
```{r}

####
parseColByIdx <- function(data, colname,sep=";") {
  
  keyIdx  <- which(colnames(data) %in% colname)
  isEmpty <- data[,keyIdx] == "" & is.na(data[,keyIdx])
  data    <- data[!isEmpty,]
  
  parse         <- data[,keyIdx]
  parsed.list   <- sapply(parse, function(x) strsplit(x,split = sep))
  reps          <- sapply(parsed.list,length)
  
  parsed        <- unlist(parsed.list)
  cnames        <- c(colnames(data[,-keyIdx]),colname)
  
  row.reps      <- unlist(mapply(rep, 1:length(reps), reps))
  data.new      <- cbind(data[row.reps, - keyIdx], parsed)
  colnames(data.new) <- cnames
  
  data.new <- sapply(data.new,function(x) as.character(x)) %>% as_tibble() %>% distinct()
  
  return(data.new)
  
}
###################
# check for delimiters ";" and ","
parseMe <- function(x) {
  delim <- c(";",",","|")
  n <- c(sum(grepl(";", x)), sum(grepl(",", x)), sum(grepl("\\|", x)))
  n.delim <- data.frame(delim,n)
  return(n.delim)
  }

##################
NormalizeStrings <- function(y) sapply(y, function(x) trimws(toupper(as.character(x)))) %>% as_tibble()


```

# filter patients
```{r standardize population, echo=FALSE}
PATIENTS_AGE_REGION <- FILTER_PATIENTS_AGE_REGION(TABLE04SAS7BDAT)
PATIENTS_AGE_REGION <- PATIENTS_AGE_REGION %>% filter(IXDAYS >= -2*365) %>% distinct()
```

# load matching resources

## ICD9GROUPING
```{r}
ICD9GROUPING <- tbl(src, "REFERENCE.ICD9GROUPING") %>% filter(ICD9 != "") %>% collect()
```

## MESH2ICD9
```{r, echo = FALSE}
MESH2ICD9 <- read.csv("~/epilepsie_preprocessing_descrStat/data/diseaseDescriptors/doid_MESH2ICD9_2016-09-15.csv", header=TRUE, sep=";")
MESH2ICD9 <- as_tibble(unique(MESH2ICD9))

# drop IDS which no MESH terms
MESH2ICD9$mesh[MESH2ICD9$mesh == ""] <- NA
x <- MESH2ICD9 %>% group_by(id) %>% select(mesh) %>% filter(!is.na(mesh)) %>% distinct()
MESH2ICD9 <- MESH2ICD9 %>% filter(id %in% x$id)

# drop IDs which no ICD9 terms
x <- MESH2ICD9 %>% group_by(id) %>% select(icd9) %>% filter(!is.na(icd9)) %>% distinct()
MESH2ICD9 <- MESH2ICD9 %>% filter(id %in% x$id)

# reshape
MESH2ICD9x <- MESH2ICD9 %>% select(id, mesh) %>% filter(!is.na(mesh))
MESH2ICD9x <- left_join(MESH2ICD9x, MESH2ICD9 %>% select(id, icd9) %>% filter(!is.na(icd9)))
MESH2ICD9  <- MESH2ICD9x %>% select(-id) %>% distinct()

#
rm(MESH2ICD9x, x)
```

## DISEASE2BIOMARKER
```{r}
DISEASE2BIOMARKER <- tbl(src, "REFERENCE.DISEASE2BIOMARKER" ) %>% collect()
DISEASE2BIOMARKER <- DISEASE2BIOMARKER %>% select(-DISEASE, -ICD10, -BIOMARKERNAME) %>% distinct()

# parse ICD9
icd9parsed        <- as_tibble(parseICD9( as.character(unique(DISEASE2BIOMARKER$ICD9)) ))
DISEASE2BIOMARKER <- left_join(DISEASE2BIOMARKER, icd9parsed, by = c("ICD9" = "unparsed")) %>% select(-ICD9) %>% dplyr::rename(ICD9 = parsed) %>% distinct()
#
rm(icd9parsed)
```

## DISEASE2GENES
```{r}
load("~/epilepsie_preprocessing_descrStat/output/disease2genes_2016-10-24.RData")
disease2genes <- disease2genes %>% dplyr::rename(score.Disease2Gene = score) %>% distinct()

# gene subelection by gene-disease-score
# (score as least as big as the minimal score of curated gene-disease associations)
min_curated_score <- disease2genes %>% filter(source_descr == "curated") %>% dplyr::select(score.Disease2Gene)
min_curated_score <- min(min_curated_score$score.Disease2Gene)
disease2genes <- disease2genes %>% filter(score.Disease2Gene >= min_curated_score, NofPmids >= 10)

# drop useless columns
disease2genes <- disease2genes %>% select(-UMLS, -score.Disease2Gene, -description, - diseaseName, -NofPmids, -PHEWAS_STRING, -source_descr) %>% distinct()
#
rm(min_curated_score)
```

## DISEASE2SYMPTOMS

```{r}
DISEASE2SYMPTOMS  <- tbl(src,"REFERENCE.DISEASE2SYMPTOMS") %>% collect()

# cutoff PUBMED_OCCURRENCE 
DISEASE2SYMPTOMS <- DISEASE2SYMPTOMS %>% filter(PUBMED_OCCURRENCE >= 10) %>% select(-PUBMED_OCCURRENCE, -TFIDF_SCORE) %>% distinct()

# MESH_DISEASE_TERM to ICD9
###########################
DISEASE2SYMPTOMS <- as_tibble(apply(DISEASE2SYMPTOMS, 2, function(x) trimws(toupper(x))))
ICD9GROUPING$ICD9_STRING   <- trimws(toupper(ICD9GROUPING$ICD9_STRING))
ICD9GROUPING$PHEWAS_STRING <- trimws(toupper(ICD9GROUPING$PHEWAS_STRING))

# -by ICD9_STRING
# -by PHEWAS_STRING
m1 <- inner_join(DISEASE2SYMPTOMS, ICD9GROUPING %>% select(ICD9_STRING, ICD9) %>% distinct(), by= c("MESH_DISEASE_TERM" = "ICD9_STRING"))
m2 <- inner_join(DISEASE2SYMPTOMS, ICD9GROUPING %>% select(PHEWAS_STRING, ICD9) %>% distinct(), by= c("MESH_DISEASE_TERM" = "PHEWAS_STRING"))

DISEASE2SYMPTOMS <- rbind(m1,m2) %>%  select(-MESH_DISEASE_TERM) %>% distinct()

rm(m1,m2)
```

## ENTREZ2 ...KEGG ...GO
```{r}
library(org.Hs.eg.db)
columns(org.Hs.eg.db)
e                <- keys(org.Hs.eg.db, keytype = "ENTREZID")

# KEGG
ENTREZ2KEGG      <- as_tibble(AnnotationDbi::select(org.Hs.eg.db, keys = e, keytype="ENTREZID" ,columns=c("ENTREZID","PATH")))
ENTREZ2KEGG      <- ENTREZ2KEGG[complete.cases(ENTREZ2KEGG),] %>% distinct()
ENTREZ2KEGG$PATH <- sapply(X = ENTREZ2KEGG$PATH, FUN = function(x) paste("hsa",x,sep=""))

# GO
ENTREZ2GO    <- as_tibble(select(org.Hs.eg.db, keys=e, keytype="ENTREZID" ,columns=c("ENTREZID","GO")))
ENTREZ2GO    <- ENTREZ2GO %>% dplyr::select(-EVIDENCE) %>% distinct()
ENTREZ2GO$GO <- gsub("GO:","",ENTREZ2GO$GO)
ENTREZ2GO    <- ENTREZ2GO[complete.cases(ENTREZ2GO),]
ENTREZ2GO$GO <- paste(ENTREZ2GO$ONTOLOGY,".",ENTREZ2GO$GO,sep="")
ENTREZ2GO    <- ENTREZ2GO %>% dplyr::select(-ONTOLOGY) %>% distinct()

detach("package:org.Hs.eg.db", unload=TRUE)
detach("package:AnnotationDbi", unload=TRUE)

rm(e)
```

# rename columns, prepare tables

* ICD9GROUPING
* MESH2ICD9
* DISEASE2BIOMARKER
* disease2genes
* DISEASE2SYMPTOMS
* ENTREZ2KEGG
* ENTREZ2GO

```{r}
DISEASE2PHEWAS    <- ICD9GROUPING %>% select(ICD9, PHEWAS_CODE) %>%  filter(PHEWAS_CODE != "") %>% distinct()
DISEASE2MESH      <- MESH2ICD9 %>% dplyr::rename(DISEASE.MESHDISEASE = mesh, DISEASE.ICD9 = icd9)
DISEASE2SYMPTOMS  <- DISEASE2SYMPTOMS %>% dplyr::rename(DISEASE.ICD9 = ICD9, DISEASE.MESHSYMPTOM = MESH_SYMPTOM_TERM)
DISEASE2BIOMARKER <- DISEASE2BIOMARKER %>% dplyr::rename(DISEASE.BIOMARKER_REC_ID = BIOMARKER_REC_ID, DISEASE.ICD9 = ICD9)
disease2genes     <- disease2genes %>% dplyr::rename(DISEASE.ENTREZ = entrez, DISEASE.GENESYMBOL = geneName, DISEASE.ICD9 = ICD9)
ENTREZ2KEGG       <- ENTREZ2KEGG %>% dplyr::rename(DISEASE.ENTREZ = ENTREZID, DISEASE.PATH = PATH)
ENTREZ2GO         <- ENTREZ2GO %>% dplyr::rename(DISEASE.ENTREZ = ENTREZID, DISEASE.GO = GO)
```

## DISEASE2PHEWAS, only 1 digit
```{r}
x <- DISEASE2PHEWAS$PHEWAS_CODE %>% as.character() %>% as.numeric() %>% (function(x) floor(10*x)/10)
DISEASE2PHEWAS$PHEWAS_CODE <- x
DISEASE2PHEWAS             <- DISEASE2PHEWAS[complete.cases(DISEASE2PHEWAS),] %>% dplyr::rename(DISEASE.ICD9 = ICD9, DISEASE.PHEWAS = PHEWAS_CODE)

rm(x)
```

## get GENETIC DISEASE DESCRIPTORS

* DISEASE2GENES
* DISEASE2GO: only enriched (hyper-geom. test, FDR)
* DISEASE2KEGG: only enriched (hyper-geom. test, FDR)
```{r}
DIS_GEN_GO_PATH <- 
  left_join(disease2genes, ENTREZ2KEGG) %>% 
  left_join(ENTREZ2GO) %>% 
  select(-DISEASE.ENTREZ) %>% 
  distinct()

# DISEASE2GENES
DISEASE2GENES <- DIS_GEN_GO_PATH %>% select(DISEASE.ICD9, DISEASE.GENESYMBOL) %>% distinct()

# DISEASE2GO
DISEASE2GO <- 
  DIS_GEN_GO_PATH %>% 
  select(DISEASE.ICD9, DISEASE.GENESYMBOL, DISEASE.GO) %>% 
  distinct() %>% 
  select(-DISEASE.GENESYMBOL) %>% 
  group_by(DISEASE.ICD9, DISEASE.GO) %>% 
  tally()

?phyper()

# DISEASE2KEGG
DISEASE2KEGG  <- DIS_GEN_GO_PATH %>% select(DISEASE.ICD9, DISEASE.PATH) %>% distinct()


rm(DIS_GEN_GO_PATH, disease2genes)
```

# build disease descriptors feature matrix

##  get ICD9 namespace from TABLE04SAS7BDAT
```{r}
DISEASES <- 
  TABLE04SAS7BDAT %>% 
  select(DIAG) %>% 
  filter(DIAG != "", !is.na(DIAG)) %>%
  dplyr::rename(DISEASE.ICD9 = DIAG) %>% 
  distinct()

# parse ICD9 Codes, e.g 0010 -> 001.0
# two leading zeros -> add dot: 00xxx -> 00.xxx
# one leading zero -> add dot: 0xxxx -> 0.xxxxx
###############################################

x00 <- grep("^[0]{2}",DISEASES$DIAG)
x0  <- grep("^[0]{1}[1-9]",DISEASES$DIAG)

DISEASES$DISEASE.ICD9[x00] <- paste("00",substr(DISEASES$DISEASE.ICD9[x00],3,3),".",substr(DISEASES$DISEASE.ICD9[x00],4,10),sep="")
DISEASES$DISEASE.ICD9[x0]  <- paste("0",substr(DISEASES$DISEASE.ICD9[x0],2,3),".",substr(DISEASES$DISEASE.ICD9[x0],4,10),sep="")
DISEASES <- parseICD9(DISEASES)
```

## transform vartype to char
```{r}

# tables list
# DISEASES
# DISEASE2PHEWAS
# DISEASE2GENES
# DISEASE2GO
# DISEASE2KEGG
# DISEASE2MESH
# DISEASE2SYMPTOMS
# DISEASE2BIOMARKER

toChar <- function(x) as_tibble(apply(x,2,function(y) trimws(toupper(y))))

DISEASES          <- toChar(DISEASES)
DISEASE2PHEWAS    <- toChar(DISEASE2PHEWAS)
DISEASE2GENES     <- toChar(DISEASE2GENES)
DISEASE2GO        <- toChar(DISEASE2GO)
DISEASE2KEGG      <- toChar(DISEASE2KEGG)
DISEASE2MESH      <- toChar(DISEASE2MESH)
DISEASE2SYMPTOMS  <- toChar(DISEASE2SYMPTOMS)
DISEASE2BIOMARKER <- toChar(DISEASE2BIOMARKER)

```

# spread / reshape
```{r}


DISEASE2PHEWAS$val <- TRUE
DISEASE2PHEWAS     <- spread(DISEASE2PHEWAS, DISEASE.PHEWAS, val, fill = FALSE, sep = "_x_" )

DISEASE2GENES$val <- TRUE
DISEASE2GENES     <- spread(DISEASE2GENES, DISEASE.GENESYMBOL, val, fill = FALSE, sep = "_x_" )

DISEASE2GO$val <- TRUE
DISEASE2GO     <- spread(DISEASE2GO, DISEASE.GO, val, fill = FALSE, sep = "_x_" )

DISEASE2KEGG$val <- TRUE
DISEASE2KEGG     <- spread(DISEASE2KEGG, DISEASE.PATH, val, fill = FALSE, sep = "_x_" )

DISEASE2MESH$val <- TRUE
DISEASE2MESH     <- spread(DISEASE2MESH, DISEASE.MESHDISEASE, val, fill = FALSE, sep = "_x_" )

DISEASE2SYMPTOMS$val <- TRUE
DISEASE2SYMPTOMS     <- spread(DISEASE2SYMPTOMS, DISEASE.MESHSYMPTOM, val, fill = FALSE, sep = "_x_" )

DISEASE2BIOMARKER$val <- TRUE
DISEASE2BIOMARKER     <- spread(DISEASE2BIOMARKER, DISEASE.BIOMARKER_REC_ID, val, fill = FALSE, sep = "_x_" )

# print summary
tables <- c("DISEASE2PHEWAS", "DISEASE2GENES", "DISEASE2GO", "DISEASE2KEGG", "DISEASE2MESH", "DISEASE2SYMPTOMS", "DISEASE2BIOMARKER")
dims   <- c(paste(dim(DISEASE2PHEWAS),collapse=" x "),
            paste(dim(DISEASE2GENES),collapse=" x "),
            paste(dim(DISEASE2GO),collapse=" x "),
            paste(dim(DISEASE2KEGG),collapse=" x "),
            paste(dim(DISEASE2MESH),collapse=" x "),
            paste(dim(DISEASE2SYMPTOMS),collapse=" x "),
            paste(dim(DISEASE2BIOMARKER),collapse=" x ")
            )
s           <- as.data.frame(dims,tables)
colnames(s) <- "nICD9 x nFeatures"
knitr::kable(s)
```

## join descriptors to DISEASES
```{r}

DISEASES.FEATMAT <- 
  left_join(DISEASES, DISEASE2PHEWAS) %>% 
  left_join(DISEASE2GENES) %>% 
  left_join(DISEASE2GO) %>% 
  left_join(DISEASE2KEGG) %>% 
  left_join(DISEASE2MESH) %>% 
  left_join(DISEASE2SYMPTOMS) %>% 
  left_join(DISEASE2BIOMARKER) 

```

## save
```{r}
save(DISEASES.FEATMAT, file="output/featureMatrix/featMat_diseaseDescr.RData",compress=TRUE)
```

