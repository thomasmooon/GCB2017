---
title: "treatment transitions"
subtitle: "incident, age 18-66"
author: "Thomas Gerlach"
output: html_notebook
date: "2017 MAR 22"
---

# setup
```{r setup, include=FALSE, echo = FALSE }
# set knitr defaults

rm(list=ls())
knitr::opts_chunk$set(echo = TRUE, fig.width=10, fig.height=10)
source("z_start.R") # initalize netezza DB, load core data
load("./data/re-do_epd183/all_events.icd9.c.RData")
data <- as.data.frame(all_events.icd9.c$data)
```

# support functions
## TreatmentTransition() function
```{r}
TreatmentTransition <- function(obs,plotTitle="", nCutoff=0, withDuplicates = FALSE, AEDs.all) {
  
  # nCutoff: Plot only rows or cols with rowsum or colsum >= nCutoff
  
  obs$SUBSTANCENAME <- as.character(obs$SUBSTANCENAME)
  
  # sort
  obs       <- obs[order(obs$ENROLID,obs$IXDAYS,obs$SUBSTANCENAME),]
  
  # define filters ####
  #####################
  
  obs$prev_ENROL <- c("")
  obs$prev_ENROL[2:(nrow(obs))]    <- obs$ENROLID[1:(nrow(obs)-1)]
  
  obs$current_ENROL <- obs$ENROLID
  obs$next_ENROL <- ""
  obs$next_ENROL[1:(nrow(obs)-1)]    <- obs$ENROLID[2:nrow(obs)]
  
  obs$current_SUBST <- obs$SUBSTANCENAME
  obs$next_SUBST <- ""
  obs$next_SUBST[1:(nrow(obs)-1)]    <- obs$SUBSTANCENAME[2:nrow(obs)]
  
  # flag duplicates within patient
  obs$duplicate <- (obs$current_ENROL == obs$next_ENROL) & (obs$current_SUBST == obs$next_SUBST)
  
  # flag first entry of a patients observation
  obs$firstObs <- obs$current_ENROL != obs$prev_ENROL
  obs$firstObs[1] <- TRUE
  
  # flag last entry of a patients observation
  obs$lastObs <- obs$current_ENROL != obs$next_ENROL
  
  # drop rows by filter criterium ####
  ####################################
  
  # drop rows where obs$firstObs and obs$lastObs both are true 
  # these are patients with only 1 treatment event -> can't have a transition
  obs <- obs %>% filter(!(firstObs & lastObs))
  
  # drop last observation, because obs$next_SUBST point to the next ENROLID
  obs <- obs %>% filter(!(lastObs))
  
  # drop duplicates, if it isn't the first observation
  if(!withDuplicates)
    obs <- obs %>% filter(!duplicate)
  
  # compute + plot transition matrix ####
  #######################################
  
  # absolute
  tm <- as.data.frame.matrix(table(obs$current_SUBST, obs$next_SUBST))
  
  # add new rows
  AED.missing.rows <- setdiff(AEDs.all,row.names(tm))
  new.rows    <- data.frame(matrix(0,length(AED.missing.rows),ncol(tm)))
  colnames(new.rows) <- colnames(tm)
  row.names(new.rows) <- AED.missing.rows
  tm <- rbind(tm,new.rows)
  
  # add new columns
  AED.missing.cols <- setdiff(AEDs.all,colnames(tm))
  new.cols    <- data.frame(matrix(0,nrow(tm),length(AED.missing.cols)))
  colnames(new.cols) <- AED.missing.cols
  row.names(new.cols) <- row.names(tm)
  tm <- cbind(tm,new.cols)
  
  # order by names
  tm <- tm[order(row.names(tm)),]
  tm <- tm[,order(colnames(tm))]
  
  # some annotation
  row.names(tm) <- paste("current", row.names(tm))
  colnames(tm)  <- paste("next",colnames(tm))
  
  # add row/col-sums to row/col-names
  row.names(tm) <- paste(row.names(tm),"n =",rowSums(tm))
  colnames(tm) <- paste(colnames(tm),"n =",colSums(tm))
  
  keep.rows <- rowSums(tm) >= nCutoff
  keep.cols <- colSums(tm) >= nCutoff
  
  # %
  tm <- apply(tm,1, FUN = function(x) round(x/sum(x),2)) %>% as.data.frame() %>% t()
  tm[is.na(tm)] <- 0
  

  if(is.matrix(tm[keep.rows, keep.cols])) {
  # https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html
  corrplot::corrplot(
    tm[keep.rows, keep.cols],
    is.corr = FALSE,
    tl.col = 1,
    method = "circle",
    outline = T,
    tl.cex = 0.75,
    tl.srt = 45,
    title = plotTitle,
    mar=c(0,0,1,0)
  )
}
  return(tm)
}

```

## "get incident ENROLID's" function
```{r}
GetIncidentMCPatients <- function(x) {
  
  # filter x by patients with incident main-comorbidities
  
  ## incident ENROLID's
  incident <- 
    x %>% 
    filter(MAIN.COMORB != "") %>% 
    dplyr::select(ENROLID, IXDAYS, MAIN.COMORB) %>% 
    distinct()
  
  incident <- 
    aggregate(formula = IXDAYS ~., data = incident, FUN = min) %>% 
    filter(IXDAYS >= 180) %>% 
    dplyr::select(ENROLID) %>% 
    distinct()
  
  ## apply filtering
  x <- x %>% filter(ENROLID %in% incident$ENROLID)

  return(x)
  }
```
# compute transitions

all AEDS
```{r}
AEDs.all <- unique(data$SUBSTANCENAME[data$isAED == TRUE])
```

## children.incident

### all children.incident
```{r}

children.incident <- AddMainComorb(data, cohort = "children")
children.incident <- GetIncidentMCPatients(children.incident)

children.incident.all <- 
  children.incident %>% 
  filter(SUBSTANCENAME != "", isAED == TRUE) %>% 
  filter(IXDAYS >= -2*365, IXDAYS <= 90) %>% # standardise observation frame to expanded MH
  select(ENROLID, IXDAYS, SUBSTANCENAME) %>%
  distinct()

nCutoff <- 0
title <- paste("children.AEDtreatment,","n=",n_distinct(children.incident.all$ENROLID),", rowSum and colSum >=",nCutoff)
children.incident.all.tm <-  TreatmentTransition(children.incident.all,title,nCutoff = nCutoff, AEDs.all = AEDs.all)
```

### children.incident with main-comorbidities
```{r}
children.incident.mc          <- unique(children.incident$MAIN.COMORB)
children.incident.mc          <- children.incident.mc[!is.na(children.incident.mc)]
children.incident.mc.l        <- vector("list", length = length(children.incident.mc))
names(children.incident.mc.l) <- children.incident.mc

children.inc.enrold.by.mc <-
  aggregate(
  IXDAYS ~ .,
  data = children.incident %>% select(ENROLID, IXDAYS, MAIN.COMORB) %>% distinct(),
  FUN = min
  ) %>% filter(IXDAYS >= 180)

for(m in 1:length(children.incident.mc)) {
  mc          <- children.incident.mc[m]
  tmp.enrolid <- children.inc.enrold.by.mc %>% filter(MAIN.COMORB == mc) %>% select(ENROLID) %>% distinct()
  
  children.incident.tmp <- 
    children.incident %>% 
    filter(SUBSTANCENAME != "", isAED == TRUE) %>% 
    filter(ENROLID %in% tmp.enrolid$ENROLID) %>% 
    select(ENROLID, IXDAYS, SUBSTANCENAME) %>%
    distinct()
  
  tmp.n <- n_distinct(children.incident.tmp$ENROLID)
  
  title <-paste("children.incident, ",mc,", n=",tmp.n,", rowSum and colSum >=",nCutoff)
children.incident.mc.l[[m]] <- TreatmentTransition(children.incident.tmp, title, nCutoff = nCutoff,  AEDs.all = AEDs.all)
}
```

#### children.incident distance(x,y), whereas x,y element of {transition main-comorbidities}


#### center transition matrices
```{r}
for(l in 1:length(children.incident.mc.l)) {
  children.incident.mc.l[[l]] <- children.incident.mc.l[[l]] - children.incident.all.tm
}
```


##### Frobenius Distance
```{r, fig.width=10, fig.height=10}
# strata vs strata
children.incident.mc.dist <- data.frame(matrix(0,length(children.incident.mc),length(children.incident.mc)))
row.names(children.incident.mc.dist) <- colnames(children.incident.mc.dist) <- children.incident.mc

for(m in 1:length(children.incident.mc)) {
for(n in 1:length(children.incident.mc)) {
  children.incident.mc.dist[m,n] <- norm(children.incident.mc.l[[m]] - children.incident.mc.l[[n]], type = "F")
  }
}

# clustered heatmap
par(cex.main=0.5)
heatmap.2(
  data.matrix(children.incident.mc.dist),
  col=bluered(50),
  margin = c(20,20),
  srtCol = 35,
  hclustfun =  function(x) hclust(x,method = "average"),
  cexRow = 0.75, cexCol = 0.75,
  main = paste("Frobenius distance of *centered* transition matrices \n children.incident"))



```





##### p-Norm, p=1

```{r, fig.width=10, fig.height=10}

# strata vs strata
children.incident.mc.dist <- data.frame(matrix(0,length(children.incident.mc),length(children.incident.mc)))
row.names(children.incident.mc.dist) <- colnames(children.incident.mc.dist) <- children.incident.mc

for(m in 1:length(children.incident.mc)) {
for(n in 1:length(children.incident.mc)) {
  children.incident.mc.dist[m,n] <- sum(abs(children.incident.mc.l[[m]] - children.incident.mc.l[[n]]))
  }
}

# clustered heatmap
par(cex.main=0.5)
heatmap.2(
  data.matrix(children.incident.mc.dist),
  col=bluered(50),
  margin = c(20,20),
  srtCol = 35,
  hclustfun =  function(x) hclust(x,method = "average"),
  cexRow = 0.75, cexCol = 0.75,
    main = paste("p1-Norm-distance of *centered* transition matrices \n children.incident"))


```


## adult.incident

### all adult.incident
```{r}

adult.incident <- AddMainComorb(data, cohort = "adult")
adult.incident <- GetIncidentMCPatients(adult.incident)

adult.incident.all <- 
  adult.incident %>% 
  filter(SUBSTANCENAME != "", isAED == TRUE) %>% 
  filter(IXDAYS >= -2*365, IXDAYS <= 90) %>% # standardise observation frame to expanded MH
  select(ENROLID, IXDAYS, SUBSTANCENAME) %>%
  distinct()

title <- paste("adult.AEDtreatment, n=",n_distinct(adult.incident.all$ENROLID),", rowSum and colSum >=",nCutoff)
adult.incident.all.tm <- TreatmentTransition(adult.incident.all,title,nCutoff = nCutoff,  AEDs.all = AEDs.all)
```

### adult.incident with main-comorbidities
```{r}
adult.incident.mc          <- unique(adult.incident$MAIN.COMORB)
adult.incident.mc          <- adult.incident.mc[!is.na(adult.incident.mc) & adult.incident.mc != ""]
adult.incident.mc.l        <- vector("list", length = length(adult.incident.mc))
names(adult.incident.mc.l) <- adult.incident.mc

adult.inc.enrold.by.mc <-
  aggregate(
  IXDAYS ~ .,
  data = adult.incident %>% select(ENROLID, IXDAYS, MAIN.COMORB) %>% distinct(),
  FUN = min
  ) %>% filter(IXDAYS >= 180)

for(m in 1:length(adult.incident.mc)) {
  mc          <- adult.incident.mc[m]
  tmp.enrolid <- adult.inc.enrold.by.mc %>% filter(MAIN.COMORB == mc) %>% select(ENROLID) %>% distinct()
  
  adult.incident.tmp <- 
    adult.incident %>% 
    filter(SUBSTANCENAME != "", isAED == TRUE) %>% 
    filter(ENROLID %in% tmp.enrolid$ENROLID) %>% 
    select(ENROLID, IXDAYS, SUBSTANCENAME) %>%
    distinct()
  
  tmp.n <- n_distinct(adult.incident.tmp$ENROLID)
  
  title <- paste("adult.incident, ",mc,", n=",tmp.n,", rowSum and colSum >=",nCutoff)
  adult.incident.mc.l[[m]] <- TreatmentTransition(adult.incident.tmp,title, nCutoff = nCutoff,  AEDs.all = AEDs.all)
}
```

#### adult.incident distance(x,y), whereas x,y element of {transition main-comorbidities}

#### center transition matrices
```{r}
for(l in 1:length(children.incident.mc.l)) {
  adult.incident.mc.l[[l]] <- adult.incident.mc.l[[l]] - adult.incident.all.tm
}
```

##### Frobenius Norm
```{r, fig.width=5, fig.height=5}
adult.incident.mc.dist <- data.frame(matrix(0,length(adult.incident.mc),length(adult.incident.mc)))
row.names(adult.incident.mc.dist) <- colnames(adult.incident.mc.dist) <- adult.incident.mc

for(m in 1:length(adult.incident.mc)) {
  for(n in 1:length(adult.incident.mc)) {
    adult.incident.mc.dist[m,n] <- norm(adult.incident.mc.l[[m]] - adult.incident.mc.l[[n]], type = "F")
  }
}

# clustered heatmap
par(cex.main=0.5)
heatmap.2(
  data.matrix(adult.incident.mc.dist),
  col=bluered(50),
  margin = c(5,5), 
  srtCol = 35,
  hclustfun =  function(x) hclust(x,method = "average"),cexRow = 0.75, cexCol = 0.75,
  main = paste("Frobenius distance of *centered* transition matrices \n adult.incident"))



```

##### p-Norm, p=1
```{r, fig.width=5, fig.height=5}
adult.incident.mc.dist <- data.frame(matrix(0,length(adult.incident.mc),length(adult.incident.mc)))
row.names(adult.incident.mc.dist) <- colnames(adult.incident.mc.dist) <- adult.incident.mc

for(m in 1:length(adult.incident.mc)) {
  for(n in 1:length(adult.incident.mc)) {
    adult.incident.mc.dist[m,n] <- sum(abs(adult.incident.mc.l[[m]] - adult.incident.mc.l[[n]]))
  }
}

# clustered heatmap
par(cex.main=0.5)
heatmap.2(
  data.matrix(adult.incident.mc.dist),
  col=bluered(50),
  margin = c(5,5), 
  srtCol = 35,
  hclustfun =  function(x) hclust(x,method = "average"),cexRow = 0.75, cexCol = 0.75,
  main = paste("p1-Norm-distance of *centered* transition matrices \n adult.incident"))



```